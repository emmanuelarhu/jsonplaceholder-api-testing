name: ðŸ§ª JSONPlaceholder API Tests & Reports

# Trigger on push to main branch and pull requests
on:
  push:
    branches: [ main, tester ]
  pull_request:
    branches: [ main, tester ]
  workflow_dispatch: # Allow manual trigger

# Set permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test-and-report:
    name: ðŸ§ª Run Tests & Generate Reports
    runs-on: ubuntu-latest

    steps:
      # âœ… Step 1: Checkout code
      - name: ðŸ“ Checkout repository
        uses: actions/checkout@v4

      # âœ… Step 2: Setup Java
      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # âœ… Step 3: Cache Maven dependencies
      - name: ðŸ“¦ Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      # âœ… Step 4: Run tests (continue even if tests fail)
      - name: ðŸ§ª Run API Tests
        run: mvn clean test
        continue-on-error: true

      # âœ… Step 5: Load previous test report history for trending
      - name: ðŸ“ˆ Load test report history
        uses: actions/checkout@v4
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      # âœ… Step 6: Generate Allure Report
      - name: ðŸ“Š Generate Allure Report
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: target/allure-results
          allure_history: allure-history
          gh_pages: gh-pages

      # âœ… Step 7: Deploy Report to GitHub Pages
      - name: ðŸš€ Deploy Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history

  # ðŸ“§ Send notifications (runs after test job completes)
  notify:
    name: ðŸ“¬ Send Notifications
    runs-on: ubuntu-latest
    needs: test-and-report
    if: always() # Run even if tests failed

    steps:
      # âœ… Step 1: Determine test results
      - name: ðŸ” Determine test status
        id: test-status
        run: |
          if [ "${{ needs.test-and-report.result }}" == "success" ]; then
            echo "status=âœ… SUCCESS" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ FAILED" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
          fi

      # âœ… Step 2: Send Email Notification
      - name: ðŸ“§ Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: '${{ steps.test-status.outputs.emoji }} JSONPlaceholder API Tests - ${{ steps.test-status.outputs.status }}'
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.EMAIL_USERNAME }}
          body: |
            ðŸ“Š JSONPlaceholder API Test Results
            
            ðŸ”— Repository: ${{ github.repository }}
            ðŸŒ¿ Branch: ${{ github.ref_name }}
            ðŸ‘¤ Triggered by: ${{ github.actor }}
            ðŸ“… Date: ${{ github.event.head_commit.timestamp }}
            
            ðŸ“‹ Test Status: ${{ steps.test-status.outputs.status }}
            
            ðŸ“Š View Full Report: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
            ðŸ”— GitHub Action: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            Last Commit:
            ðŸ’¬ "${{ github.event.head_commit.message }}"
            ðŸ‘¤ by ${{ github.event.head_commit.author.name }}

      # âœ… Step 3: Send Slack Notification
      - name: ðŸ“± Send Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_CHANNEL: 'general' # Change this to your preferred channel
          SLACK_COLOR: ${{ steps.test-status.outputs.color }}
          SLACK_USERNAME: 'JSONPlaceholder Tests Bot'
          SLACK_ICON: 'https://jsonplaceholder.typicode.com/favicon.ico'
          SLACK_TITLE: 'JSONPlaceholder API Tests - ${{ steps.test-status.outputs.status }}'
          SLACK_MESSAGE: |
            ðŸ”— *Repository:* ${{ github.repository }}
            ðŸŒ¿ *Branch:* ${{ github.ref_name }}
            ðŸ‘¤ *Triggered by:* ${{ github.actor }}
            
            ðŸ“Š *View Report:* https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
            ðŸ”— *GitHub Action:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ðŸ’¬ *Last Commit:* "${{ github.event.head_commit.message }}"